# Exploit: SSRFによるファイルアップロード検査バイパス

このエクスプロイトは、アプリケーションに存在するSSRF（サーバサイドリクエストフォージェリ）脆弱性を悪用し、ファイルアップロード時の検証メカニズムを完全にバイパスします。

-   **ターゲット脆弱性:** SSRFによるファイル検査回避
-   **関連ファイル:** `product.php`

## 脆弱性の概要

商品の出品機能において、アップロードされたファイルを検査するために外部のAPI（検査サーバ）を呼び出す仕様になっています。しかし、この検査サーバのURLをリクエストパラメータ（`url`）で任意に上書きすることが可能です。

攻撃者は、この仕組みを悪用し、常に「安全」というレスポンスを返す自前の偽サーバを検査先として指定することで、本来であればブロックされるべき不正なファイル（任意の拡張子・内容）を自由にアップロードできます。

## エクスプロイトの構成

このエクスプロイトは2つのスクリプトで構成されています。

1.  `fake_inspector.py`
    -   Flaskで構築された、偽のファイル検査サーバです。
    -   `/` エンドポイントでPOSTリクエストを受け付け、アップロードされたファイル情報（ファイル名など）を表示します。
    -   受け取ったファイルの内容に関わらず、常に`{"status": 200}`というJSONを返し、アプリケーションに「このファイルは安全である」と誤認させます。

2.  `exploit.py`
    -   攻撃全体を自動化するメインスクリプトです。
    -   ユーザーの認証情報を用いてWebサイトにログインします。
    -   SSRF脆弱性を突き、検査先として`fake_inspector.py`を指定しながら、本来許可されないテキストファイル (`pwned.txt`) のアップロードを試みます。
    -   最終的に、アップロードが成功したことを証明する検証用URLを出力します。

## セットアップと実行方法

### 1. 必要ライブラリのインストール

このエクスプロイトはPython3で動作し、以下のライブラリを必要とします。

```bash
pip install requests beautifulsoup4 flask
```

### 2. スクリプトの設定

実行前に`exploit.py`ファイルを開き、お使いの環境に合わせて2つの変数を編集する必要があります。

-   `TARGET_URL`: 標的となるアプリケーションのURLに書き換えてください。（例: `http://192.168.178.128`）
-   `FAKE_INSPECTOR_URL`: `fake_inspector.py`を起動するマシンのIPアドレスに書き換えてください。コンテナからアクセスできる必要があります。
-   `LOGIN_ID` と `LOGIN_PW`: 有効なユーザーアカウントの認証情報に書き換えてください。

### 3. エクスプロイトの実行

1.  **ターミナル1: 偽の検査サーバを起動**
    ```bash
    python fake_inspector.py
    ```
    サーバが`0.0.0.0:8888`でリクエストを待ち受けます。

2.  **ターミナル2: メインスクリプトを実行**
    設定が完了したら、メインスクリプトを実行して攻撃を開始します。
    ```bash
    python exploit.py
    ```

### 4. 成功判定

スクリプトの実行が成功すると、最終的に以下のような成功メッセージと検証用のURLが出力されます。

```
[SUCCESS] Verification URL: http://<サーバーIP>/img.php?id=...
    - Visit this URL in your browser. It should display the content of 'pwned.txt'.
```# fake-filecheck-E
